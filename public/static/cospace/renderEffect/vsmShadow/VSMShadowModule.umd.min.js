(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["VSMShadowModule"]=e():t["VSMShadowModule"]=e()})("undefined"!==typeof self?self:this,(function(){return function(t){var e={};function a(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,a),s.l=!0,s.exports}return a.m=t,a.c=e,a.d=function(t,e,r){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},a.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)a.d(r,s,function(e){return t[e]}.bind(null,s));return r},a.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s="fae3")}({"05f8":function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(t){this.m_uid=-1,this.m_uniformParam=null,this.m_dirty=!1,this.m_shdCtx=null,this.m_shdCtx=t,this.m_uid=r.s_uid++}getUid(){return this.m_uid}update(){null!=this.m_uniformParam&&this.m_dirty&&(this.m_dirty=!1,this.m_uniformParam.uProbe.update())}getGlobalUinform(){return null!=this.m_uniformParam?this.m_uniformParam.cloneUniform():null}destroy(){null!=this.m_uniformParam&&this.m_uniformParam.destroy(),this.m_uniformParam=null,this.m_shdCtx=null}}r.s_uid=0,e.MaterialPipeBase=r},"084e":function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(t,e=!0){this.m_shdCtx=null,this.uProbe=null,this.uniform=null,this.m_shdCtx=t,e&&(this.uProbe=t.createShaderUniformProbe(),this.uniform=t.createShaderGlobalUniform())}getNames(){return[]}cloneUniform(){return this.m_shdCtx.cloneShaderGlobalUniform(this.uniform)}buildData(){this.m_shdCtx.updateGlobalUinformDataFromProbe(this.uniform,this.uProbe,this.getNames()),this.uProbe.update()}destroy(){this.uProbe=null,this.uniform=null,this.m_shdCtx=null}}e.GlobalUniformParamBase=r},"19ec":function(t,e,a){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=r(a("e439"));function i(t){return new s.default(t)}e.create=i},"1eb2":function(t,e,a){"use strict";if("undefined"!==typeof window){var r=window.document.currentScript,s=a("8875");r=s(),"currentScript"in document||Object.defineProperty(document,"currentScript",{get:s});var i=r&&r.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);i&&(a.p=i[1])}},5216:function(t,e,a){"use strict";var r;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t["ENV_LIGHT_PARAM"]=0]="ENV_LIGHT_PARAM",t[t["ENV_AMBIENT_LIGHT"]=1]="ENV_AMBIENT_LIGHT",t[t["FOG"]=2]="FOG",t[t["FOG_EXP2"]=3]="FOG_EXP2",t[t["VSM_SHADOW"]=4]="VSM_SHADOW",t[t["GLOBAL_LIGHT"]=5]="GLOBAL_LIGHT"}(r||(r={})),e.MaterialPipeType=r},"5d74":function(t,e,a){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=r(a("b3bd"));class i{constructor(t,e,a){this.m_horizonal=!0,this.m_paramData=new Float32Array([1,1,1,4]),this.vertColorEnabled=!1,this.premultiplyAlpha=!1,this.fogEnabled=!1,this.m_currMap=null,this.m_horizonal=t,this.m_uniqueName="OccBlur",this.m_uniqueName+=t?"H":"V",this.m_currMap=e,this.m_paramData[3]=a}setShadowRadius(t){this.m_paramData[3]=t}buildBufParams(){}buildTextureList(t){t.add2DMap(this.m_currMap,"",!1)}buildShader(t){this.m_horizonal&&t.addDefine("HORIZONAL_PASS","1"),t.addDefine("SAMPLE_RATE","0.25"),t.addDefine("HALF_SAMPLE_RATE","0.125"),t.uniform.useViewPort(!1,!0),t.addFragUniform("vec4","u_params",0),t.useVertSpaceMats(!1,!1,!1),t.addFragMainCode("\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n    vec4 r = vec4( fract( v * PackFactors ), v );\n    r.yzw -= r.xyz * ShiftRight8; // tidy overflow\n    return r * PackUpscale;\n}\n\nfloat unpackRGBAToDepth( const in vec4 v ) {\n    return dot( v, UnpackFactors );\n}\n\nvec4 pack2HalfToRGBA( vec2 v ) {\n    vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\n    return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n    return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nvoid main() {\n\n    float mean = 0.0;\n    float squared_mean = 0.0;\n    \n    vec2 resolution = u_viewParam.zw;\n    \n    float radius = u_params[3];\n    vec4 c4 = VOX_Texture2D( u_sampler0, ( gl_FragCoord.xy ) / resolution );    \n    // This seems totally useless but it's a crazy work around for a Adreno compiler bug\n    float depth = unpackRGBAToDepth( c4 );\n\n    for ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {\n\n        #ifdef HORIZONAL_PASS\n\n            vec2 distribution = unpackRGBATo2Half( VOX_Texture2D( u_sampler0, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );\n            mean += distribution.x;\n            squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\n        #else\n\n            float depth = unpackRGBAToDepth( VOX_Texture2D( u_sampler0, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );\n            mean += depth;\n            squared_mean += depth * depth;\n\n        #endif\n\n    }\n\n    mean = mean * HALF_SAMPLE_RATE;\n    squared_mean = squared_mean * HALF_SAMPLE_RATE;\n\n    float std_dev = sqrt( squared_mean - mean * mean );\n\n    FragColor0 = pack2HalfToRGBA( vec2( mean, std_dev ) );\n\n}\n"),t.addVertMainCode("\nvoid main() {\n    gl_Position =  vec4(a_vs,1.0);\n}\n")}createUniformData(){let t=new s.default;return t.uniformNameList=["u_params"],t.dataList=[this.m_paramData],t}getUniqueName(){return this.m_uniqueName}}e.OccBlurDecorator=i},8875:function(t,e,a){var r,s,i;(function(a,n){s=[],r=n,i="function"===typeof r?r.apply(e,s):r,void 0===i||(t.exports=i)})("undefined"!==typeof self&&self,(function(){function t(){var e=Object.getOwnPropertyDescriptor(document,"currentScript");if(!e&&"currentScript"in document&&document.currentScript)return document.currentScript;if(e&&e.get!==t&&document.currentScript)return document.currentScript;try{throw new Error}catch(d){var a,r,s,i=/.*at [^(]*\((.*):(.+):(.+)\)$/gi,n=/@([^@]*):(\d+):(\d+)\s*$/gi,o=i.exec(d.stack)||n.exec(d.stack),h=o&&o[1]||!1,u=o&&o[2]||!1,m=document.location.href.replace(document.location.hash,""),c=document.getElementsByTagName("script");h===m&&(a=document.documentElement.outerHTML,r=new RegExp("(?:[^\\n]+?\\n){0,"+(u-2)+"}[^<]*<script>([\\d\\D]*?)<\\/script>[\\d\\D]*","i"),s=a.replace(r,"$1").trim());for(var l=0;l<c.length;l++){if("interactive"===c[l].readyState)return c[l];if(c[l].src===h)return c[l];if(h===m&&c[l].innerHTML&&c[l].innerHTML.trim()===s)return c[l]}return null}}return t}))},a9f4:function(t,e,a){"use strict";var r;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t["Default"]=1]="Default",t[t["VSM"]=1]="VSM"}(r||(r={})),e.ShadowMode=r},ab73:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(){this.type="vec4",this.data=null,this.name="u_vsmParams",this.arrayLength=3}}class s{constructor(){this.type="vec4",this.data=new Float32Array([.1,.1,.1,1,1,.1,600,3500,.3,0,.9,5e-4,0,0,800,800,-500,-500,1e3,1e3]),this.name="u_envLightParams",this.arrayLength=5}}class i{constructor(){this.type="mat4",this.data=null,this.name="u_shadowMat",this.arrayLength=0}}class n{constructor(){this.type="vec4",this.data=null,this.name="u_stageParam",this.arrayLength=0}}class o{constructor(){this.type="vec4",this.data=null,this.name="u_viewParam",this.arrayLength=0}}class h{constructor(){this.type="vec4",this.data=null,this.name="u_frustumParam",this.arrayLength=0}}class u{constructor(){this.type="vec4",this.data=null,this.name="u_cameraPosition",this.arrayLength=0}}class m{constructor(){this.type="vec4",this.positionName="u_lightPositions",this.colorName="u_lightColors"}}class c{}c.LocalTransformMatUNS="u_objMat",c.CameraViewMatUNS="u_viewMat",c.CameraProjectiveMatUNS="u_projMat",c.FrustumParam=new h,c.CameraPosParam=new u,c.StageParam=new n,c.ViewportParam=new o,c.ShadowMatrix=new i,c.ShadowVSMParams=new r,c.GlobalLight=new m,c.EnvLightParams=new s,e.default=c},b3bd:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(){this.uns="",this.types=null,this.uniformSize=0,this.uniformNameList=null,this.locations=null,this.dataList=null,this.calcModels=null,this.always=!0,this.next=null}getDataRefFromUniformName(t){if(null!=this.uniformNameList){let e=this.uniformNameList,a=e.length;for(let r=0;r<a;++r)if(t==e[r])return this.dataList[r]}return null}setDataRefFromUniformName(t,e){if(null!=this.uniformNameList){let a=this.uniformNameList,r=a.length;for(let s=0;s<r;++s)if(t==a[s]){this.dataList[s]=e;break}}}copyDataFromProbe(t){this.types=[];for(let e=0;e<t.uniformsTotal;++e)this.types.push(t.uniformTypes[e]);this.uniformSize=t.uniformsTotal}destroy(){let t=0,e=this.dataList.length;for(;t<e;++t)this.dataList[t]=null;if(null!=this.calcModels)for(e=this.calcModels.length,t=0;t<e;++t)this.calcModels[t].destroy(),this.calcModels[t]=null;this.dataList=null,this.types=null,this.locations=null,this.calcModels=null}}e.default=r},b498:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=a("5216"),s=a("05f8"),i=a("ff8e"),n=a("a9f4"),o=a("d846");class h extends s.MaterialPipeBase{constructor(){super(...arguments),this.m_direcMatrix=null,this.m_offetMatrix=null,this.m_params=null,this.m_shadowMap=null,this.m_camVersion=-1}setShadowMap(t){this.m_shadowMap=t}resetPipe(){}getTextures(t,e,a){return null!=this.m_shadowMap?(null==e&&(e=[]),e.push(this.m_shadowMap),t.uniform.addShadowMap(n.ShadowMode.VSM),e):null}useShaderPipe(t,e){null!=this.m_uniformParam&&(t.addDefine("VOX_USE_SHADOW","1"),t.addVarying("vec4","v_shadowPos"),this.m_uniformParam.use(t),t.addShaderObject(o.VSMShaderCode))}getPipeTypes(){return[r.MaterialPipeType.VSM_SHADOW]}getPipeKey(t){switch(t){case r.MaterialPipeType.VSM_SHADOW:return"["+t+"]";default:break}return""}initialize(t,e){if(null==this.m_uniformParam){this.m_direcMatrix=t,this.m_offetMatrix=e,this.m_offetMatrix.identity(),this.m_offetMatrix.setScaleXYZ(.5,.5,.5),this.m_offetMatrix.setTranslationXYZ(.5,.5,.5);let a=new i.GlobalVSMShadowUniformParam(this.m_shdCtx);this.m_params=a.buildUniformData(this.m_direcMatrix.getLocalFS32()),this.m_uniformParam=a}}updateShadowCamera(t){this.m_camVersion!=t.version&&(this.m_camVersion=t.version,this.m_direcMatrix.copyFrom(t.getVPMatrix()),this.m_direcMatrix.append(this.m_offetMatrix),this.setDirec(t.getNV()),this.m_dirty=!0)}setShadowParam(t,e,a){this.m_params[0]=t,this.m_params[1]=e,this.m_params[2]=a,this.m_dirty=!0}setShadowIntensity(t){this.m_params[3]=t,this.m_dirty=!0}setColorIntensity(t){this.m_params[6]=t,this.m_dirty=!0}setShadowRadius(t){this.m_params[2]=t,this.m_dirty=!0}setShadowBias(t){this.m_params[0]=t,this.m_dirty=!0}setShadowSize(t,e){this.m_params[4]=t,this.m_params[5]=e,this.m_dirty=!0}setDirec(t){this.m_params[8]=-t.x,this.m_params[9]=-t.y,this.m_params[10]=-t.z,this.m_dirty=!0}destroy(){this.m_shadowMap=null,this.m_direcMatrix=null,this.m_params=null,this.m_offetMatrix=null,super.destroy()}}e.default=h},ca07:function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(){this.vertColorEnabled=!1,this.premultiplyAlpha=!1,this.fogEnabled=!1,this.m_uniqueName="DepthWrite"}buildBufParams(){}buildTextureList(t){}buildShader(t){t.addVarying("vec4","v_pos"),t.addFragMainCode("\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8; // tidy overflow\n\treturn r * PackUpscale;\n}\nvoid main() {\n    // Higher precision equivalent of the gl_FragCoord.z. This assumes depthRange has been left to its default values.\n    float fragCoordZ = 0.5 * v_pos[2] / v_pos[3] + 0.5;\n    FragColor0 = packDepthToRGBA( fragCoordZ );\n}\n"),t.addVertMainCode("\nvoid main() {\n    worldPosition = u_objMat * vec4(a_vs, 1.0);\n    viewPosition = u_viewMat * worldPosition;\n    gl_Position =  u_projMat * viewPosition;\n    v_pos = gl_Position;\n}\n")}createUniformData(){return null}getUniqueName(){return this.m_uniqueName}}e.DepthWriteDecorator=r},d846:function(t,e,a){"use strict";a.r(e),a.d(e,"VSMShaderCode",(function(){return i}));var r="vec4 pack2HalfToRGBA( vec2 v ) {\r\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));\r\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);\r\n}\r\nvec2 unpackRGBATo2Half( vec4 v ) {\r\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\r\n}\r\n\r\nvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\r\n\r\n    return unpackRGBATo2Half( VOX_Texture2D( shadow, uv ) );\r\n\r\n}\r\n#ifdef VOX_USE_SHADOW\r\nfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ) {\r\n\r\n    float occlusion = 1.0;\r\n\r\n    vec2 distribution = texture2DDistribution( shadow, uv );\r\n\r\n    float hard_shadow = step( compare , distribution.x ); // Hard Shadow\r\n\r\n    if (hard_shadow != 1.0 ) {\r\n\r\n        float distance = compare - distribution.x ;\r\n        float variance = max( 0.0, distribution.y * distribution.y );\r\n        float softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality\r\n        softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed\r\n        occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\r\n\r\n    }\r\n    return occlusion;\r\n\r\n}\r\nfloat getVSMShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\r\n\r\n    //float shadow = 1.0;\r\n    \r\n    shadowCoord.xyz /= shadowCoord.w;\r\n    shadowCoord.z += shadowBias;\r\n    \r\n    // if ( something && something ) breaks ATI OpenGL shader compiler\r\n    // if ( all( something, something ) ) using this instead\r\n\r\n    bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r\n    bool inFrustum = all( inFrustumVec );\r\n\r\n    bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r\n\r\n    bool frustumTest = all( frustumTestVec );\r\n\r\n    return frustumTest ? VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z ) : 1.0;\r\n    // if ( frustumTest ) {\r\n    //     shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\r\n    // }\r\n    // return shadow;\r\n}\r\nfloat getVSMShadowFactor(in vec4 shadowPos) {\r\n    \r\n    float shadow = getVSMShadow( VOX_VSM_SHADOW_MAP, u_vsmParams[1].xy, u_vsmParams[0].x, u_vsmParams[0].z, shadowPos );\r\n    float shadowIntensity = 1.0 - u_vsmParams[0].w;\r\n    shadow = clamp(shadow, 0.0, 1.0) * (1.0 - shadowIntensity) + shadowIntensity;\r\n    float f = clamp(dot(worldNormal,u_vsmParams[2].xyz),0.001,1.0);\r\n    shadow = f > 0.0001 ? min(shadow,clamp(f, shadowIntensity,1.0)) : shadowIntensity;\r\n    f = u_vsmParams[1].z;\r\n    return shadow * (1.0 - f) + f;\r\n}\r\nvoid useVSMShadow(inout vec4 color) {\r\n    \r\n    float factor = getVSMShadowFactor(v_shadowPos);\r\n    color.xyz *= vec3(factor);\r\n}\r\n#endif";let s="\nvoid calcShadowPos(in vec4 wpos) {\n    v_shadowPos = u_shadowMat * wpos;\n}\n";const i={vert:"",vert_head:s,vert_body:"\n#ifdef VOX_USE_SHADOW\n    // if use real worldPosition , it maybe make shadow calculation error.\n    calcShadowPos( oWorldPosition );\n#endif\n",frag:"",frag_head:r,frag_body:"\n#ifdef VOX_USE_SHADOW\nuseVSMShadow( FragColor0 );\n#endif\n"}},e439:function(t,e,a){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=a("5d74"),i=a("ca07"),n=r(a("b498"));class o{constructor(t){this.m_rscene=null,this.m_vsmData=null,this.m_direcCamera=null,this.m_fboDepth=null,this.m_fboOccBlur=null,this.m_verOccBlurPlane=null,this.m_horOccBlurPlane=null,this.m_camPosArr=[1,800,1],this.m_shadowBias=-5e-4,this.m_shadowRadius=2,this.m_shadowIntensity=.8,this.m_colorIntensity=.1,this.m_shadowMapW=512,this.m_shadowMapH=512,this.m_viewWidth=3e3,this.m_viewHeight=3e3,this.m_near=10,this.m_far=3e3,this.m_depthRtt=null,this.m_occBlurRtt=null,this.m_fboIndex=0,this.m_processIDList=null,this.m_rendererStatus=-1,this.m_rendererProcessStatus=-1,this.m_shadowCamVersion=-1,this.m_buildShadowDelay=120,this.force=!0,this.m_fboIndex=t}resetPipe(){}getTextures(t,e,a){return this.m_vsmData.getTextures(t,e,a)}useShaderPipe(t,e){this.m_vsmData.useShaderPipe(t,e)}getPipeTypes(){return this.m_vsmData.getPipeTypes()}getPipeKey(t){return this.m_vsmData.getPipeKey(t)}getGlobalUinform(){return this.m_vsmData.getGlobalUinform()}initialize(t,e,a=120,r=!1){null==this.m_rscene&&(this.m_rscene=t,this.m_camPos=t.createVector3(),this.m_camPos.fromArray(this.m_camPosArr),this.m_zero=t.createVector3(),this.m_axisZ=t.createVector3(0,0,1),this.m_buildShadowDelay=a,this.m_processIDList=e.slice(0),this.initConfig(e,!1))}setMapSize(t,e){this.m_shadowMapW=t,this.m_shadowMapH=e}setCameraPosition(t){null!=this.m_camPos?this.m_camPos.copyFrom(t):t.toArray(this.m_camPosArr)}setCameraNear(t){this.m_near=t}setCameraFar(t){this.m_far=t}setCameraViewSize(t,e){this.m_viewWidth=t,this.m_viewHeight=e}setShadowRadius(t){this.m_shadowRadius=t}setShadowBias(t){this.m_shadowBias=t}setShadowIntensity(t){this.m_shadowIntensity=t,null!=this.m_vsmData&&this.m_vsmData.setShadowIntensity(this.m_shadowIntensity)}setColorIntensity(t){this.m_colorIntensity=t,null!=this.m_vsmData&&this.m_vsmData.setColorIntensity(this.m_colorIntensity)}getShadowMap(){return this.m_depthRtt}getVSMData(){return this.m_vsmData}getCamera(){return this.m_direcCamera}setRendererProcessIDList(t){null!=this.m_fboDepth&&(this.m_processIDList=t.slice(0),this.m_fboDepth.setRProcessIDList(t))}initConfig(t,e=!1){let a=this.m_rscene,r=this.m_rscene.getRenderProxy().renderingState;this.m_vsmData=new n.default(this.m_rscene.getRenderProxy().uniformContext),this.m_vsmData.initialize(a.createMatrix4(),a.createMatrix4()),this.m_vsmData.setShadowIntensity(this.m_shadowIntensity);let o=this.m_rscene.materialBlock.createSimpleMaterial(new i.DepthWriteDecorator);this.m_fboDepth=this.m_rscene.createFBOInstance(),this.m_fboDepth.asynFBOSizeWithViewport(),this.m_fboDepth.setClearRGBAColor4f(1,1,1,1),this.m_fboDepth.createFBOAt(this.m_fboIndex,this.m_shadowMapW,this.m_shadowMapH,!0,!1,0),this.m_depthRtt=this.m_fboDepth.setRenderToRGBATexture(null,0),this.m_fboDepth.setRProcessIDList(t),this.m_fboDepth.setGlobalRenderState(r.NORMAL_STATE),this.m_fboDepth.setGlobalMaterial(o,!1,!1),this.m_fboOccBlur=this.m_rscene.createFBOInstance(),this.m_fboOccBlur.asynFBOSizeWithViewport(),this.m_fboOccBlur.setClearRGBAColor4f(1,1,1,1),this.m_fboOccBlur.createFBOAt(this.m_fboIndex,this.m_shadowMapW,this.m_shadowMapH,!0,!1,0),this.m_occBlurRtt=this.m_fboOccBlur.setRenderToRGBATexture(null,0);let h=new s.OccBlurDecorator(!1,this.m_depthRtt,this.m_shadowRadius),u=this.m_rscene.materialBlock.createSimpleMaterial(h),m=this.m_rscene.entityBlock.createEntity();m.copyMeshFrom(this.m_rscene.entityBlock.screenPlane),m.setMaterial(u),this.m_verOccBlurPlane=m,h=new s.OccBlurDecorator(!0,this.m_occBlurRtt,this.m_shadowRadius),u=this.m_rscene.materialBlock.createSimpleMaterial(h);let c=this.m_rscene.entityBlock.createEntity();c.copyMeshFrom(this.m_rscene.entityBlock.screenPlane),c.setMaterial(u),this.m_horOccBlurPlane=c,this.m_direcCamera=this.m_rscene.createCamera(),this.m_vsmData.setShadowMap(this.getShadowMap()),this.updateData()}updateData(){if(null!=this.m_direcCamera){let t=this.m_viewWidth,e=this.m_viewHeight;this.m_direcCamera.lookAtRH(this.m_camPos,this.m_zero,this.m_axisZ),this.m_direcCamera.orthoRH(this.m_near,this.m_far,-.5*e,.5*e,-.5*t,.5*t),this.m_direcCamera.setViewXY(0,0),this.m_direcCamera.setViewSize(t,e),this.m_direcCamera.update()}null!=this.m_vsmData&&(this.m_fboDepth.resizeFBO(this.m_shadowMapW,this.m_shadowMapH),this.m_fboOccBlur.resizeFBO(this.m_shadowMapW,this.m_shadowMapH),this.m_vsmData.updateShadowCamera(this.m_direcCamera),this.m_vsmData.setShadowRadius(this.m_shadowRadius),this.m_vsmData.setShadowBias(this.m_shadowBias),this.m_vsmData.setShadowSize(this.m_shadowMapW,this.m_shadowMapH),this.m_vsmData.update())}upate(){this.m_buildShadowDelay=32,this.m_shadowCamVersion=this.m_direcCamera.version,this.updateData()}getRendererProcessStatus(){let t=31;for(let e=0;e<this.m_processIDList.length;++e)t+=t*this.m_rscene.getRenderProcessAt(e).getStatus();return t}run(){this.m_direcCamera.version!=this.m_shadowCamVersion&&(this.m_shadowCamVersion=this.m_direcCamera.version,this.m_vsmData.updateShadowCamera(this.m_direcCamera),this.m_vsmData.update());let t=this.force;if(t)this.buildShadow();else{if(this.m_rendererStatus!=this.m_rscene.getRendererStatus()){let e=this.getRendererProcessStatus();this.m_rendererProcessStatus!=e&&(this.m_rendererProcessStatus=e,t=!0),this.m_rendererStatus=this.m_rscene.getRendererStatus()}this.m_buildShadowDelay>0&&(this.m_buildShadowDelay%15==0&&(t=!0),this.m_buildShadowDelay--),t&&this.buildShadow()}this.force=!1}buildShadow(){this.m_fboDepth.useCamera(this.m_direcCamera,!1),this.m_fboDepth.run(!0,!0,!0,!0),this.m_fboDepth.useMainCamera(),this.m_fboOccBlur.setRenderToRGBATexture(this.m_occBlurRtt,0),this.m_fboOccBlur.runBegin(),this.m_fboOccBlur.drawEntity(this.m_verOccBlurPlane,!1,!0),this.m_fboOccBlur.runEnd(),this.m_fboOccBlur.setRenderToRGBATexture(this.m_depthRtt,0),this.m_fboOccBlur.runBegin(),this.m_fboOccBlur.drawEntity(this.m_horOccBlurPlane,!1,!0),this.m_fboOccBlur.runEnd(),this.m_fboOccBlur.setRenderToBackBuffer()}destroy(){this.m_rscene=null,this.m_vsmData=null,this.m_direcCamera=null,this.m_fboDepth=null,this.m_fboOccBlur=null,this.m_verOccBlurPlane=null,this.m_horOccBlurPlane=null}}e.ShadowVSMModule=o,e.default=o},fae3:function(t,e,a){"use strict";a.r(e);a("1eb2");var r=a("19ec");for(var s in r)["default"].indexOf(s)<0&&function(t){a.d(e,t,(function(){return r[t]}))}(s)},ff8e:function(t,e,a){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=r(a("ab73")),i=a("084e");class n extends i.GlobalUniformParamBase{getNames(){return[s.default.ShadowMatrix.name,s.default.ShadowVSMParams.name]}buildUniformData(t){let e=new Float32Array([-5e-4,0,4,.8,512,512,.1,0,1,1,1,0]);return this.uProbe.addMat4Data(t,1),this.uProbe.addVec4Data(e,s.default.ShadowVSMParams.arrayLength),this.buildData(),e}use(t,e=1){t.addFragUniformParam(s.default.ShadowVSMParams),t.addVertUniformParam(s.default.ShadowMatrix)}}e.GlobalVSMShadowUniformParam=n}})}));