(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["OccPostOutlineModule"]=e():t["OccPostOutlineModule"]=e()})("undefined"!==typeof self?self:this,(function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s="fae3")}({"1eb2":function(t,e,i){"use strict";if("undefined"!==typeof window){var n=window.document.currentScript,s=i("8875");n=s(),"currentScript"in document||Object.defineProperty(document,"currentScript",{get:s});var r=n&&n.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);r&&(i.p=r[1])}},"239e":function(t,e,i){"use strict";var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=i("f3a2"),r=n(i("b3bd"));class a{constructor(){this.m_colorData=new Float32Array([1,0,1,1]),this.vertColorEnabled=!1,this.premultiplyAlpha=!1,this.fogEnabled=!1,this.m_uniqueName="PostOutlinePre"}setRGB3f(t,e,i){this.m_colorData[0]=t,this.m_colorData[1]=e,this.m_colorData[2]=i}buildBufParams(){}buildTextureList(t){}buildShader(t){t.addFragUniform("vec4","u_colorFill",0),t.addFragMainCode("\n    FragColor0 = u_colorFill;\n"),t.addVertMainCode("\n    worldPosition = u_objMat * vec4(a_vs, 1.0);\n    gl_Position = u_projMat * u_viewMat * worldPosition;\n")}createUniformData(){let t=new r.default;return t.uniformNameList=["u_colorFill"],t.dataList=[this.m_colorData],t}getShaderCodeObjectUUID(){return s.ShaderCodeUUID.None}getShaderCodeObject(){return null}getUniqueName(){return this.m_uniqueName}}e.OutlinePreDecorator=a},"6e01":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class n{static Clamp(t,e,i){return Math.max(Math.min(t,i),e)}static IsPowerOf2(t){return 0==(t&t-1)}static CalcCeilPowerOfTwo(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}static CalcNearestCeilPow2(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}static CalcFloorCeilPow2(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}static DegreeToRadian(t){return n.MATH_PI_OVER_180*t}static Log2(t){return Math.log(t)/Math.LN2}static GetMaxMipMapLevel(t,e){return Math.round(n.Log2(Math.max(t,e))+1)}static SafeACos(t){return t<=-1?n.MATH_PI:t>=1?0:Math.acos(t)}static GetNearestCeilPow2(t){let e=1;while(e<t)e<<=1;return e}static GetMinRadian(t,e){return e%=n.MATH_2PI,t%=n.MATH_2PI,e<t?(e=n.MATH_2PI-t+e,e>n.MATH_PI?e-n.MATH_2PI:e):e>t?(t=n.MATH_2PI-e+t,t>n.MATH_PI?n.MATH_2PI-t:-t):0}static GetMinDegree(t,e){let i=0;return e>=270&&t<90?i=(e-(t+360))%180:e<=90&&t>=270?i=(e+360-t)%180:(i=e-t,i>180?(i-=360,i%=360):i<-180&&(i+=360,i%=360)),i}static GetDegreeByXY(t,e){if(Math.abs(t)<1e-5)return e>=0?270:90;let i=180*Math.atan(e/t)/Math.PI;return t>=0?i:180+i}static GetRadianByXY(t,e){if(Math.abs(t)<n.MATH_MIN_POSITIVE)return e>=0?n.MATH_1PER2PI:n.MATH_3PER2PI;let i=Math.atan(e/t);return t>=0?i:n.MATH_PI+i}static GetRadianByCos(t,e,i){var s=Math.acos(t);return e>=0?s:n.MATH_PI+s}}n.MATH_MIN_POSITIVE=1e-5,n.MATH_MAX_NEGATIVE=-1e-5,n.MATH_MAX_POSITIVE=268435454,n.MATH_MIN_NEGATIVE=-268435454,n.MATH_1_OVER_255=1/255,n.MATH_PI=Math.PI,n.MATH_2PI=2*n.MATH_PI,n.MATH_3PER2PI=1.5*n.MATH_PI,n.MATH_1PER2PI=.5*n.MATH_PI,n.MATH_1_OVER_PI=1/n.MATH_PI,n.MATH_1_OVER_360=1/360,n.MATH_1_OVER_180=1/180,n.MATH_180_OVER_PI=180/n.MATH_PI,n.MATH_PI_OVER_180=n.MATH_PI/180,n.MATH_LN2=.6931471805599453,e.default=n},"811b":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i("97a2"),s=i("fb17"),r=i("239e"),a=1e-6,o=-1e-6;class l{constructor(){this.distance=0,this.intersectBoo=!1}containsPoint(t){let e=this.nv.dot(t)-this.distance;return e>a?1:e<o?-1:0}intersectAABB(t,e){this.intersectBoo=!1;let i=this.__tV0;i.setXYZ(e.x,t.y,e.z);let n=this.containsPoint(i);return i.setXYZ(e.x,t.y,t.z),n+=this.containsPoint(i),i.setXYZ(t.x,t.y,t.z),n+=this.containsPoint(i),i.setXYZ(t.x,t.y,e.z),n+=this.containsPoint(i),i.setXYZ(e.x,e.y,e.z),n+=this.containsPoint(i),i.setXYZ(e.x,e.y,t.z),n+=this.containsPoint(i),i.setXYZ(t.x,e.y,t.z),n+=this.containsPoint(i),i.setXYZ(t.x,e.y,e.z),n+=this.containsPoint(i),this.intersectBoo=n<8,n<-7?-1:n>7?1:0}}class u{constructor(){this.m_rscene=null,this.m_testPlane=new l,this.m_targets=null,this.m_preDecor=null,this.m_preMaterial=null,this.m_screenDecor=null,this.m_boundsDecor=null,this.m_outlinePlane=null,this.m_displayPlane=null,this.m_running=!0,this.m_runningFlag=!0,this.m_sizeScaleRatio=.5,this.m_preColorRTT=null,this.m_outLineRTT=null,this.m_colorFBO=null,this.m_outlineFBO=null}initialize(t,e=0,i=null){if(null==this.m_rscene){this.m_rscene=t;let a=this.m_rscene.entityBlock;this.m_bounds=a.createAABB(),this.m_expandBias=a.createVector3(10,10,10),this.m_testPlane.__tV0=a.createVector3(),this.m_testPlane.nv=a.createVector3(0,1,0);let o=this.m_rscene.materialBlock;this.m_preDecor=new r.OutlinePreDecorator,this.m_preMaterial=o.createSimpleMaterial(this.m_preDecor),this.m_preMaterial.initializeByCodeBuf(!1),this.m_preColorRTT=this.m_rscene.textureBlock.createRTTTex2D(32,32,!1),this.m_outLineRTT=this.m_rscene.textureBlock.createRTTTex2D(32,32,!1),this.m_colorFBO=this.m_rscene.createFBOInstance(),this.m_colorFBO.setFBOSizeFactorWithViewPort(this.m_sizeScaleRatio),this.m_colorFBO.setClearRGBAColor4f(0,0,0,1),this.m_colorFBO.createFBOAt(e,512,512,!0,!1,0),this.m_colorFBO.setRenderToTexture(this.m_preColorRTT,0),this.m_colorFBO.setRProcessIDList(i),this.m_colorFBO.setGlobalMaterial(this.m_preMaterial,!1,!0),this.m_outlineFBO=this.m_rscene.createFBOInstance(),this.m_outlineFBO.setFBOSizeFactorWithViewPort(this.m_sizeScaleRatio),this.m_outlineFBO.setClearRGBAColor4f(0,0,0,0),this.m_outlineFBO.createFBOAt(e,512,512,!0,!1,0),this.m_outlineFBO.setRenderToTexture(this.m_outLineRTT,0),this.m_outlineFBO.setRProcessIDList(null),this.m_rscene.setRenderToBackBuffer(),this.m_screenDecor=new n.OccPostOutLineDecorator(!0,this.m_preColorRTT),this.m_screenDecor.setRGB3f(1,0,0),this.m_screenDecor.setThickness(1),this.m_screenDecor.setDensity(1.5),this.m_boundsDecor=new n.OccPostOutLineDecorator(!1,this.m_preColorRTT),this.m_boundsDecor.setRGB3f(1,0,0),this.m_boundsDecor.setThickness(1),this.m_boundsDecor.setDensity(1.5),this.m_outlinePlane=a.createEntity(),this.m_outlinePlane.copyMeshFrom(a.screenPlane),this.m_outlinePlane.setMaterial(o.createSimpleMaterial(this.m_screenDecor)),this.m_boundsEntity=a.createEntity(),this.m_boundsEntity.copyMeshFrom(a.unitBox),this.m_boundsEntity.setMaterial(o.createSimpleMaterial(this.m_boundsDecor));let l=this.m_rscene.getRenderProxy().renderingState,u=o.createSimpleMaterial(new s.OccPostOutLineScreen(this.m_outLineRTT));this.m_displayPlane=a.createEntity(),this.m_displayPlane.setMaterial(u),this.m_displayPlane.copyMeshFrom(this.m_outlinePlane),this.m_displayPlane.setRenderState(l.BACK_TRANSPARENT_ALWAYS_STATE)}}getPreColorRTT(){return this.m_preColorRTT}setFBOSizeScaleRatio(t){this.m_sizeScaleRatio=t,this.m_colorFBO.setFBOSizeFactorWithViewPort(this.m_sizeScaleRatio),this.m_outlineFBO.setFBOSizeFactorWithViewPort(this.m_sizeScaleRatio)}setOutlineThickness(t){this.m_screenDecor.setThickness(t),this.m_boundsDecor.setThickness(t)}setOutlineDensity(t){this.m_screenDecor.setDensity(t),this.m_boundsDecor.setDensity(t)}setOcclusionDensity(t){this.m_screenDecor.setOcclusionDensity(t),this.m_boundsDecor.setOcclusionDensity(t)}setRGB3f(t,e,i){this.m_screenDecor.setRGB3f(t,e,i),this.m_boundsDecor.setRGB3f(t,e,i)}setPostRenderState(t){this.m_displayPlane.setRenderState(t)}setTargetList(t){this.m_targets=t}getTargetList(){return this.m_targets}setBoundsOffset(t){t<1&&(t=1),this.m_expandBias.setXYZ(t,t,t)}startup(){this.m_running=!0}quit(){this.m_running=!1}isRunning(){return this.m_running}drawBegin(){if(this.m_runningFlag=this.m_running,this.m_running&&null!=this.m_targets&&this.m_targets.length>0){if(this.m_targets[0].isInRendererProcess()){this.m_runningFlag=!1;for(let t=0;t<this.m_targets.length;++t)if(this.m_targets[t].isRenderEnabled()){this.m_runningFlag=!0;break}if(this.m_runningFlag){let t=this.m_rscene.getRenderProxy(),e=t.renderingState;t.useRenderState(e.NORMAL_STATE);let i=t.colorMask,n=this.m_bounds,s=this.m_colorFBO,r=this.m_targets.length;this.m_preDecor.setRGB3f(1,0,0),s.runBegin(),n.reset();for(let o=0;o<r;++o)this.m_targets[o].isRenderEnabled()&&(s.drawEntity(this.m_targets[o],!1,!0),n.union(this.m_targets[o].getGlobalBounds()));n.expand(this.m_expandBias),n.updateFast();let a=!1;if(n.getWidth()<12&&(a=!0),n.getHeight()<12&&(a=!0),n.getLong()<12&&(a=!0),a){let t=n.min,e=n.min;t.x-=6,e.x+=6,t.y-=6,e.y+=6,t.z-=6,e.z+=6,n.updateFast()}this.m_boundsEntity.setScaleXYZ(n.getWidth(),n.getHeight(),n.getLong()),this.m_boundsEntity.setPosition(this.m_bounds.center),this.m_boundsEntity.update(),s.lockColorMask(i.ALL_FALSE),s.clearDepth(1);for(let o=0;o<r;++o)this.m_targets[o].setVisible(!1);s.run(!1,!1,!1,!0),s.lockColorMask(i.GREEN_TRUE);for(let o=0;o<r;++o)this.m_targets[o].setVisible(!0);this.m_preDecor.setRGB3f(0,1,0),s.updateGlobalMaterialUniform();for(let o=0;o<r;++o)s.drawEntity(this.m_targets[o],!1,!0);s.runEnd(),s.unlockRenderColorMask(),s.unlockMaterial()}}}else this.m_runningFlag=!1}draw(){if(this.m_runningFlag){let t=this.m_rscene.getCamera(),e=t.getNV();e.scaleBy(t.getZNear()+1),e.addBy(t.getPosition()),this.m_testPlane.distance=this.m_testPlane.nv.dot(e),this.m_testPlane.nv.copyFrom(t.getNV()),this.m_outlineFBO.runBegin();let i=this.m_testPlane.intersectAABB(this.m_bounds.min,this.m_bounds.max);i<=0?(this.m_screenDecor.setTexSize(this.m_colorFBO.getFBOWidth(),this.m_colorFBO.getFBOHeight()),this.m_outlineFBO.drawEntity(this.m_outlinePlane,!1,!0)):(this.m_boundsDecor.setTexSize(this.m_colorFBO.getFBOWidth(),this.m_colorFBO.getFBOHeight()),this.m_outlineFBO.drawEntity(this.m_boundsEntity,!1,!0)),this.m_outlineFBO.runEnd(),this.m_rscene.setRenderToBackBuffer(),this.m_rscene.drawEntity(this.m_displayPlane,!0,!0)}}drawTest(){this.m_running&&null!=this.m_targets&&this.m_targets.length>0&&this.m_targets[0].isRenderEnabled()&&(this.m_colorFBO.runEnd(),this.m_colorFBO.unlockMaterial(),this.m_rscene.setRenderToBackBuffer())}drawEnd(){}}e.default=u},8875:function(t,e,i){var n,s,r;(function(i,a){s=[],n=a,r="function"===typeof n?n.apply(e,s):n,void 0===r||(t.exports=r)})("undefined"!==typeof self&&self,(function(){function t(){var e=Object.getOwnPropertyDescriptor(document,"currentScript");if(!e&&"currentScript"in document&&document.currentScript)return document.currentScript;if(e&&e.get!==t&&document.currentScript)return document.currentScript;try{throw new Error}catch(m){var i,n,s,r=/.*at [^(]*\((.*):(.+):(.+)\)$/gi,a=/@([^@]*):(\d+):(\d+)\s*$/gi,o=r.exec(m.stack)||a.exec(m.stack),l=o&&o[1]||!1,u=o&&o[2]||!1,c=document.location.href.replace(document.location.hash,""),_=document.getElementsByTagName("script");l===c&&(i=document.documentElement.outerHTML,n=new RegExp("(?:[^\\n]+?\\n){0,"+(u-2)+"}[^<]*<script>([\\d\\D]*?)<\\/script>[\\d\\D]*","i"),s=i.replace(n,"$1").trim());for(var h=0;h<_.length;h++){if("interactive"===_[h].readyState)return _[h];if(_[h].src===l)return _[h];if(l===c&&_[h].innerHTML&&_[h].innerHTML.trim()===s)return _[h]}return null}}return t}))},"97a2":function(t,e,i){"use strict";var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=n(i("b3bd")),r=n(i("6e01"));class a{constructor(t,e){this.m_screenPlaneEnabled=!0,this.m_params=new Float32Array([32,32,1.3,2,1,1,1,1,.2,0,0,0]),this.vertColorEnabled=!1,this.premultiplyAlpha=!1,this.fogEnabled=!1,this.m_currMap=null,this.m_screenPlaneEnabled=t,this.m_uniqueName="OccPostOutLineDecorator",null!=e&&(this.m_uniqueName+="Tex"),t&&(this.m_uniqueName+="Pl"),this.m_currMap=e}buildBufParams(){}buildTextureList(t){t.addDiffuseMap(this.m_currMap)}buildShader(t){t.addFragUniform("vec4","u_params",3),this.m_screenPlaneEnabled&&(t.addDefine("VOX_SCREEN_PLANE","1"),t.useVertSpaceMats(!1,!1,!1)),t.addFragMainCode("\nconst float factor = 1.0 / 9.0;\nconst float floatReciprocalGamma = (1.0 / 2.2);\nvoid main() {\n\n    vec4 param = u_params[0];\n\n    #ifdef VOX_SCREEN_PLANE\n        vec2 puv = v_uv.xy;\n    #else\n        vec2 puv = gl_FragCoord.xy/param.xy;\n    #endif\n    \n    vec2 dv = param.ww / param.xy;\n    vec4 srcColor = VOX_Texture2D( VOX_DIFFUSE_MAP, puv );\n\n    // FragColor0 = vec4(srcColor.xyz, 1.0);\n    // return;\n\n    vec2 fc = srcColor.xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv + dv ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv - dv ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv + vec2(dv.x ,-dv.y) ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv + vec2(-dv.x ,dv.y) ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv + vec2(dv.x ,0) ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv + vec2(0 ,dv.y) ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv - vec2(dv.x ,0) ).xy;\n    fc.xy += VOX_Texture2D( VOX_DIFFUSE_MAP, puv - vec2(0 ,dv.y) ).xy;\n    fc.xy *= factor;\n    \n    float dis = abs(fc.x - srcColor.x);\n\n    float fk = step(max(fc.y, srcColor.y), 0.0001);\n    float fa = u_params[2].x;\n    fa += (1.0 - fk) * (1.0 - fa);\n\n    dis *= param.z;\n    dis = pow(dis * dis * dis, floatReciprocalGamma);\n\n    param = u_params[1];\n    param.w *= dis * fa;\n    FragColor0 = param;\n    // FragColor0 += vec4(0.0,0.2,0.0,0.3);\n    // for test\n    //FragColor0 = vec4(vec3(1.0,1.0,0.0), 1.0);\n}\n"),t.addVertMainCode("\n    #ifdef VOX_SCREEN_PLANE\n        gl_Position = vec4(a_vs, 1.0);\n        v_uv = a_uvs.xy;\n    #else\n        gl_Position = u_projMat * u_viewMat * u_objMat * vec4(a_vs, 1.0);\n    #endif\n")}setThickness(t){this.m_params[3]=r.default.Clamp(t,.1,5)}setDensity(t){this.m_params[2]=r.default.Clamp(t,.1,5)}setOcclusionDensity(t){this.m_params[8]=r.default.Clamp(t,0,1)}setRGB3f(t,e,i){this.m_params[4]=t,this.m_params[5]=e,this.m_params[6]=i}setAlpha(t){this.m_params[7]=t}setTexSize(t,e){this.m_params[0]=t,this.m_params[1]=e}createUniformData(){let t=new s.default;return t.uniformNameList=["u_params"],t.dataList=[this.m_params],t}getUniqueName(){return this.m_uniqueName}destroy(){this.m_currMap=null}}e.OccPostOutLineDecorator=a},a062:function(t,e,i){"use strict";var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const s=n(i("811b"));function r(){return new s.default}e.OcclusionPostOutline=s.default,e.create=r},b3bd:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(){this.uns="",this.types=null,this.uniformSize=0,this.uniformNameList=null,this.locations=null,this.dataList=null,this.calcModels=null,this.always=!0,this.next=null}getDataRefFromUniformName(t){if(null!=this.uniformNameList){let e=this.uniformNameList,i=e.length;for(let n=0;n<i;++n)if(t==e[n])return this.dataList[n]}return null}setDataRefFromUniformName(t,e){if(null!=this.uniformNameList){let i=this.uniformNameList,n=i.length;for(let s=0;s<n;++s)if(t==i[s]){this.dataList[s]=e;break}}}copyDataFromProbe(t){this.types=[];for(let e=0;e<t.uniformsTotal;++e)this.types.push(t.uniformTypes[e]);this.uniformSize=t.uniformsTotal}destroy(){let t=0,e=this.dataList.length;for(;t<e;++t)this.dataList[t]=null;if(null!=this.calcModels)for(e=this.calcModels.length,t=0;t<e;++t)this.calcModels[t].destroy(),this.calcModels[t]=null;this.dataList=null,this.types=null,this.locations=null,this.calcModels=null}}e.default=n},f3a2:function(t,e,i){"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),function(t){t["None"]="",t["Default"]="pbr",t["Lambert"]="lambert",t["PBR"]="pbr"}(n||(n={})),e.ShaderCodeUUID=n},fae3:function(t,e,i){"use strict";i.r(e);i("1eb2");var n=i("a062");for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s)},fb17:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(t){this.vertColorEnabled=!1,this.premultiplyAlpha=!1,this.fogEnabled=!1,this.m_currMap=null,this.m_uniqueName="OccPostOutLineScreen",null!=t&&(this.m_uniqueName+="Tex"),this.m_currMap=t}buildBufParams(){}buildTextureList(t){t.addDiffuseMap(this.m_currMap)}buildShader(t){t.useVertSpaceMats(!1,!1,!1),t.addFragMainCode("\n    FragColor0 = VOX_Texture2D(VOX_DIFFUSE_MAP, v_uv.xy);\n"),t.addVertMainCode("\n    gl_Position = vec4(a_vs,1.0);\n    v_uv = a_uvs.xy;\n")}createUniformData(){return null}getUniqueName(){return this.m_uniqueName}destroy(){this.m_currMap=null}}e.OccPostOutLineScreen=n}})}));